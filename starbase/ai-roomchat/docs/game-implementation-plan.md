# 게임 구현 계획: 프롬프트 제작기 & 등록 탭 정리

## 1. 분석 요약
- **프롬프트 제작기 홈**은 `useMakerHome` 훅을 통해 세트 목록을 불러오고, 새로고침/생성/가져오기/내보내기/삭제/이름 변경을 모두 지원하는 컨테이너-프리젠터 구조를 사용한다.
- **등록 탭(`RankNewClient`)**은 게임 메타데이터 입력, 역할·슬롯 구성, 규칙 체크리스트, 난입 모드 토글, 이미지 업로드 등 한 화면에서 게임 등록 과정을 마칠 수 있도록 구성돼 있다.

## 2. 페이지별 유지 요소와 정리 대상

### 2.1 프롬프트 제작기
**유지해야 할 흐름**
- 세트 목록 컨테이너(`MakerHomeContainer`)의 권한 체크, 로컬 스토리지 기반 배경 재사용, 목록 헤더 문구 로직은 플레이어 허브와 톤을 맞추므로 유지.
- 목록 카드 화면의 고정 폭/배경 처리, 로딩/빈 상태 대응, 빠른 작업 버튼은 제작자의 반복 동선이므로 유지.
- 하단 시트(`QuickActionsSheet`)의 새 세트 생성·JSON 가져오기·목록 새로고침 트리오는 입출력 동작의 최소 세트이므로 유지.
- 에디터 핵심 기능(노드 추가, 저장, 인스펙터 열기, 히스토리 내보내기)은 룰 편집에 필수이므로 유지.

**정비/축소 후보**
- 홈 화면에 중복된 새로고침 버튼이 부동 시트와 목록 상단에 모두 존재하므로, 버튼 배치를 단일화하거나 역할을 분리.
- 에디터 내 `useMakerEditor` 반환값이 방대해 가독성이 떨어지므로, 상태 그룹화를 위해 컨텍스트 분리 또는 커스텀 훅(예: 저장 관련, 선택 관련)을 도입.
- 자동 저장 히스토리 내보내기 UI는 숨겨진 상태여서, 고급 사용자 전용 패널로 이동시키는 방안을 검토.

### 2.2 등록 탭
**유지해야 할 흐름**
- 배경 동기화 및 뒤로 가기 버튼은 캐릭터 허브와 시각적 일관성을 제공하므로 유지.
- `RolesEditor`, `SlotMatrix`, `RulesChecklist` 카드 분리는 온보딩 단계별 가이드를 제공하므로 유지.
- 난입 허용 토글 + 종료 조건 입력, 실시간 매칭 모드 선택 등 핵심 규칙 옵션은 게임 밸런싱에 필수.
- 제출 시 Supabase 등록 → 슬롯 업서트 → 성공 후 이동 흐름은 데이터 정합성을 보장하므로 유지.

**정비/축소 후보**
- 등록 가이드 문구와 체크리스트가 긴 고정 텍스트이므로, 다국어 준비 시 별도 CMS나 구성 객체로 분리.
- 이미지 업로드/표지 미리보기 부재 → 썸네일 프리뷰 추가 또는 기본 이미지 안내를 더 명확히.
- `registerGame` 내부에서 역할 이름 유효성, 슬롯 수 검증 로직을 서버 공유 유틸로 이전해 중복 방지.

## 3. 구현 및 리팩터링 로드맵

### 3.1 1단계 – 데이터 구조 정비
- Maker 세트와 Rank 게임 등록이 공유하는 **배경/프롬프트 세트 식별자** 로컬 상태를 공통 스토리지 훅으로 추출한다.
- Supabase 호출 래퍼(`withTable`)와 등록 API를 서버-클라이언트 공용 유틸로 재구성해 에러 처리와 로깅을 일관화한다.
- 매칭 → 방 → 본게임 전환 시 공통으로 참조하는 **GameSession Store(가칭)**를 정의해 게임 ID, 슬롯/역할 매핑, 룸 생성 시각 등을 저장한다.

#### 예상 문제 & 대응
- **스토리지 훅 동시 사용 시 레이스**: 비동기 초기화 과정에서 Maker/Rank가 서로 다른 세트 ID를 덮어쓸 수 있음 → 초기화 타임스탬프를 추적하고 최신 변경만 반영하도록 `compare-and-set` 패턴 적용.
- **Supabase 호출 실패 후 반복 재시도**: 동일 API를 여러 곳에서 호출할 경우 로깅이 중복될 수 있음 → API 유틸에 공통 retry/backoff 설정과 request ID 삽입.
- **GameSession Store 스키마 확장성**: 슬롯 커스터마이징이 늘어날 경우 키 폭주 → Store에 `version` 필드를 두고, 마이그레이션 함수로 스키마 변경 시 자동 변환.

### 3.2 2단계 – UI 모듈 재배치
- Maker 홈의 새로고침 버튼 위치를 조정하고, 시트와 상단 버튼이 다른 액션을 담당하도록 UX 재설계.
- 등록 탭의 안내 텍스트를 구성 객체 또는 MDX로 이동해 유지보수가 쉬운 콘텐츠 계층을 만든다.
- 에디터의 패널 상태, 자동 저장 기능을 `MakerEditorContext`(가칭)로 이동시켜 컴포넌트 간 의존성을 축소한다.
- 매칭 로비 UI에서 방 카드가 GameSession Store를 통해 현재 예약된 슬롯 수, 남은 슬롯, 역할 요약을 즉시 노출하도록 카드 컴포넌트를 재사용 가능한 상태로 분리한다.

#### 예상 문제 & 대응
- **UX 재배치 시 사용성 저하 우려**: 기존 제작자들이 익숙한 위치가 바뀔 수 있음 → 피처 플래그로 신 UI를 제한 공개하고, 유저 피드백을 수집해 단계적 롤아웃.
- **MDX/구성 객체 분리 시 번들 크기 증가**: 정적 콘텐츠가 번들에 포함되면 초기 로딩이 느려질 수 있음 → `dynamic import`와 정적 JSON fetch를 혼합해 최초 진입 시 최소 데이터만 로딩.
- **Context 분리 후 Prop Drilling 재발**: 하위 컴포넌트가 새 컨텍스트에 즉시 적응하지 못할 수 있음 → 컴포넌트별 adapter 훅을 정의해 기존 props 계약을 유지하면서 내부적으로 컨텍스트를 사용.

### 3.3 3단계 – 확장 기능 및 검증
- 게임 등록 시 이미지 미리보기, 규칙 토글과 `RulesChecklist` 간의 상호 검증(예: 난입 허용 시 종료 변수 필수)을 추가한다.
- Maker JSON 가져오기 시 스키마 버전 확인 로직을 추가하고, 호환되지 않는 경우 업그레이드 안내 배너를 띄운다.
- 등록 완료 후 곧바로 테스트 전투를 시작할 수 있는 CTA(예: “매치 시뮬레이터 열기”)를 Rank 허브와 연동한다.
- 룸 생성 시 `RoleSlotMatrix` 데이터를 캐시하고, 플레이어 매칭 단계에서 슬롯이 점유될 때마다 상태를 업데이트하여 메인 게임 진입 시 자동으로 역할별 초기화 데이터를 주입한다.

#### 예상 문제 & 대응
- **이미지 업로드 용량 초과/실패**: 사용자마다 업로드 환경이 다름 → 업로드 전 클라이언트에서 용량·확장자 검증, 실패 시 재업로드 힌트 제공, 서버에는 업로드 한도 초과 로그 추가.
- **규칙 상호 검증 충돌**: 조건이 복잡해질수록 경고가 남발될 수 있음 → 검증 로직을 스키마 기반으로 구성하고, 경고 우선순위를 조정해 한 번에 한 오류만 노출.
- **JSON 스키마 버전 불일치**: 구버전 파일이 업로드될 수 있음 → 마이그레이션 단계를 UI로 노출하고, 자동 변환 실패 시 디프 비교와 가이드 제공.
- **테스트 전투 CTA 남용**: 테스트 방이 다수 생성되면 리소스 낭비 → CTA 실행 시 자동 삭제 타이머와 사용량 제한 설정.

### 3.4 4단계 – 테스트 전략
- Maker/Rank 공통 훅에 대한 단위 테스트를 추가해 로컬 스토리지 파싱, Supabase 응답 에러 케이스를 검증한다.
- 등록 폼 통합 테스트: 역할 슬롯 누락, 이미지 업로드 실패, 난입 조건 미입력 시 경고 등 주요 분기 검증.
- JSON Import/Export E2E: 제작기가 올바른 노드/엣지 구조를 재현하는지 Playwright 시나리오로 확인.

#### 예상 문제 & 대응
- **테스트 환경에서 로컬 스토리지 모킹 누락**: 브라우저/Node 환경 차이로 실패 가능 → Jest setup에 공통 storage mock 추가, Playwright는 `storageState` fixture로 초기 상태 유지.
- **Supabase 의존 테스트 불안정**: 네트워크 불안으로 flake 발생 → Supabase 호출을 테스트 더블로 대체하고, E2E는 전용 테스트 프로젝트/테이블 사용.
- **Playwright CI 실행 시간 증가**: E2E 시나리오가 늘어나면 10분 이상 소요될 수 있음 → 시나리오를 태그로 그룹화하고, PR에서는 핵심 시나리오만 실행하도록 워크플로 조정.

## 4. 예상 산출물 & 후속 과제
- 통합 배경/세트 스토리지 훅, Supabase 유틸 리팩터링 PR
- Maker 홈/에디터 UI 정돈 및 고급 기능 패널화 PR
- 등록 탭 안내 콘텐츠 분리 및 규칙 검증 보강 PR
- 테스트 보강과 CI 파이프라인 알림 정비 PR
- GameSession Store 버전 관리 및 마이그레이션 가이드 문서화

## 5. 매칭 → 방 → 본게임 흐름 계획
- **매칭 페이지**: 선택한 게임 ID를 기준으로 GameSession Store를 초기화하고, Supabase에서 슬롯/역할 배치 데이터를 사전 로딩한다. 플레이어가 특정 방을 선택할 때 잔여 슬롯, 권장 역할, 준비 여부를 보여주는 `MatchRoomSummary` 컴포넌트를 제공한다.
- **방 생성 단계**: 방을 만들 때 `RoomInitService`가 슬롯과 역할 데이터를 가져와 각 슬롯에 대한 고유 식별자(슬롯 번호, 역할 태그, 인원 제한)를 생성한다. 호스트는 이 데이터를 기반으로 슬롯별 설명을 수정하고, 변경 사항은 GameSession Store와 Supabase 방 레코드에 동시에 반영한다.
- **방 입장/검색 단계**: 플레이어가 방을 검색해 입장할 때 `SlotAssignmentFlow`가 가용 슬롯을 탐색하고, 선택 즉시 해당 슬롯 번호와 역할 정보를 GameSession Store에 바인딩한다. 중복 할당 방지를 위해 Optimistic Lock + Supabase RPC를 활용한다.
- **본게임 진입**: 시작 버튼을 누르면 GameSession Store의 최종 슬롯 매핑을 검증하고, 메인 게임 페이지로 전환하면서 역할별 초기 데이터(예: 시작 프롬프트, 스킬 쿨다운)를 주입한다. 본게임에서는 Store를 읽기 전용으로 전환해 상태 일관성을 유지한다.

### 예상 문제 & 대응
- **슬롯 데이터 동시 갱신 충돌**: 방 호스트와 참가자가 동시에 슬롯을 수정할 경우 데이터 경합 가능 → 슬롯 레코드에 버전 필드와 Supabase Row Level Security를 활용해 낙관적 잠금 구현.
- **방 검색 성능 저하**: 실시간 방 수가 늘어나면 쿼리 비용 증가 → 실시간 채널을 이용해 변경 사항만 스트리밍하고, 클라이언트는 캐싱된 리스트에 패치 적용.
- **본게임 진입 전 검증 실패**: Store와 Supabase 상태가 불일치할 수 있음 → 진입 전 서버 측 `validate_session` RPC 호출로 슬롯-역할 매핑을 재검증하고, 실패 시 자동 롤백/재동기화 UI 제공.

---
**백엔드 TODO**: Supabase 역할/슬롯 검증 함수 공통화, RoomInitService용 슬롯/역할 캐시 테이블 및 락 RPC 추가, `validate_session` RPC 및 슬롯 버전 필드 도입, 이미지 업로드 정책(용량/파일형식) 강화, 등록/매칭 로그 감사 테이블 확장.
**추가 필요 사항**: 다국어 대비 문자열 리소스 분리, 매칭/룸 UI 카피 검수, GameSession Store 스키마 및 Maker JSON 버전 문서화, 테스트 환경용 Supabase 프로젝트 분리.
**진행 상황**: 구현 계획 고도화 및 리스크 대응 전략 문서화 완료 (문서 업데이트).
