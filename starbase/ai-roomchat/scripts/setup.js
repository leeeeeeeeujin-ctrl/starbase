#!/usr/bin/env node
/**
 * Starbase Setup Wizard
 * 
 * ëŒ€í™”í˜• ì„¤ì¹˜ ë„êµ¬ - í™œì„±í™”í•  ê¸°ëŠ¥ì„ ì„ íƒ
 */

const fs = require('fs')
const path = require('path')
const readline = require('readline')

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
})

const FEATURES = [
  {
    name: 'rank',
    emoji: 'ðŸŽ®',
    title: 'Rank Game System',
    description: 'í„´ì œ AI ê²Œìž„, ë§¤ì¹­ ì‹œìŠ¤í…œ, ì„¸ì…˜ ê´€ë¦¬',
    required: false,
    dependencies: ['character'],
  },
  {
    name: 'maker',
    emoji: 'ðŸ› ï¸',
    title: 'Prompt Maker',
    description: 'í”„ë¡¬í”„íŠ¸ ì œìž‘ ë„êµ¬, ìŠ¬ë¡¯ ì‹œìŠ¤í…œ',
    required: false,
    dependencies: [],
  },
  {
    name: 'admin',
    emoji: 'ðŸ‘‘',
    title: 'Admin Portal',
    description: 'ê´€ë¦¬ìž ëŒ€ì‹œë³´ë“œ, í†µê³„, ì„¤ì •',
    required: false,
    dependencies: [],
  },
  {
    name: 'arena',
    emoji: 'âš”ï¸',
    title: 'Arena',
    description: 'PvP ì•„ë ˆë‚˜ ì‹œìŠ¤í…œ',
    required: false,
    dependencies: ['character'],
  },
  {
    name: 'chat',
    emoji: 'ðŸ’¬',
    title: 'Chat & Messaging',
    description: 'ì±„íŒ…, AI í”„ë¡ì‹œ, ë©”ì‹œì§•',
    required: false,
    dependencies: [],
  },
  {
    name: 'character',
    emoji: 'ðŸŽ­',
    title: 'Character System',
    description: 'ìºë¦­í„° ìƒì„±/ê´€ë¦¬ (ë‹¤ë¥¸ ê¸°ëŠ¥ì˜ ê¸°ë°˜)',
    required: true,
    dependencies: [],
  },
  {
    name: 'analytics',
    emoji: 'ðŸ“Š',
    title: 'Analytics',
    description: 'ì‚¬ìš©ëŸ‰ ì¶”ì , ì—ëŸ¬ ë¦¬í¬íŒ…',
    required: false,
    dependencies: [],
  },
]

function question(prompt) {
  return new Promise(resolve => {
    rl.question(prompt, resolve)
  })
}

async function main() {
  console.log('\nðŸš€ Welcome to Starbase Setup!\n')
  console.log('Select which features you want to enable:\n')

  const selectedFeatures = new Set()

  // Required features
  FEATURES.filter(f => f.required).forEach(f => {
    selectedFeatures.add(f.name)
    console.log(`${f.emoji} ${f.title} - REQUIRED`)
  })

  console.log('')

  // Optional features
  for (const feature of FEATURES.filter(f => !f.required)) {
    console.log(`\n${feature.emoji} ${feature.title}`)
    console.log(`   ${feature.description}`)
    
    if (feature.dependencies.length > 0) {
      console.log(`   Dependencies: ${feature.dependencies.join(', ')}`)
    }

    const answer = await question(`   Enable? (Y/n): `)
    
    if (!answer || answer.toLowerCase() === 'y' || answer.toLowerCase() === 'yes') {
      selectedFeatures.add(feature.name)
      
      // Add dependencies
      feature.dependencies.forEach(dep => {
        if (!selectedFeatures.has(dep)) {
          console.log(`   â†’ Also enabling dependency: ${dep}`)
          selectedFeatures.add(dep)
        }
      })
    }
  }

  console.log('\nðŸ“ Generating configuration...\n')

  // Generate .env.local
  const envContent = FEATURES.map(feature => {
    const enabled = selectedFeatures.has(feature.name)
    return `FEATURE_${feature.name.toUpperCase()}=${enabled}`
  }).join('\n')

  const envPath = path.join(process.cwd(), '.env.local')
  
  // Preserve existing env vars
  let existingEnv = ''
  if (fs.existsSync(envPath)) {
    existingEnv = fs.readFileSync(envPath, 'utf8')
    // Remove old feature flags
    existingEnv = existingEnv.split('\n')
      .filter(line => !line.startsWith('FEATURE_'))
      .join('\n')
  }

  const finalEnv = `${existingEnv}\n\n# Feature Flags (generated by setup)\n${envContent}\n`
  
  fs.writeFileSync(envPath, finalEnv)

  console.log('âœ… Configuration saved to .env.local\n')
  console.log('ðŸ“¦ Enabled features:')
  selectedFeatures.forEach(name => {
    const feature = FEATURES.find(f => f.name === name)
    console.log(`   ${feature.emoji} ${feature.title}`)
  })

  console.log('\nðŸŽ‰ Setup complete! Run `npm run dev` to start.\n')
  
  rl.close()
}

main().catch(error => {
  console.error('Setup failed:', error)
  process.exit(1)
})
