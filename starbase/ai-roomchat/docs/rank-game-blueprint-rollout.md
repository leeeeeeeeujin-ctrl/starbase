# 랭크 게임 청사진 구현 계획

## 1. 목표 요약
- **목적**: 기존 문서에 정리된 메인 게임 청사진을 실제 코드와 데이터 계층으로 옮길 수 있도록, 순차적인 구현 단계를 정의한다.
- **범위**: 매칭 진입(솔로/듀오/캐주얼), 프롬프트 제작기, 게임 등록 옵션, 실시간/비실시간 전투 로직, 오디오·히스토리 연동까지 포함한다.
- **출력물**: 각 단계별 완료 조건, 참조해야 할 컴포넌트/엔드포인트, Supabase 테이블 매핑, 리팩터링 우선순위.

## 2. 상위 구조
1. **사전 준비** – 공용 상태와 스토리지 키를 정비해 페이지 간 일관성을 만든다.
2. **매칭 퍼널 통합** – 로비→모드 선택→매칭 대기→전투 실행까지 자동화한다.
3. **프롬프트 엔진 확장** – 프롬프트 제작기/등록 탭의 변수를 통합 파이프라인으로 연결한다.
4. **전투 세션 & 히스토리** – AI 대화, 승패, 난입, 가시성 로직을 세션 엔진으로 흡수한다.
5. **오디오/비주얼 디스패치** – 캐릭터 기반 배경/사운드와 UI 상태 전환을 최종 반영한다.
6. **QA 및 운영 체크리스트** – 실환경 배포 시 확인해야 할 항목을 명시한다.

## 3. 단계별 구현 방향

### 3.1 사전 준비
- `useGameRoom` / `useMatchmakingSession`
  - 공통 컨텍스트를 도입해 로비, 메인룸, 매칭 페이지가 동일한 `game`, `roles`, `slots`, `participants` 구조를 참조하도록 한다.
  - `page_state_map.md` 기준으로 사용 중인 `localStorage` 키(`rank:selectedHero`, `rank:lastMode` 등)를 정리하고, 불필요한 항목은 제거한다.
- **완료 조건**: 페이지 이동 시 선택 정보가 유실되지 않고, 동일 구조체로 직렬화/역직렬화가 가능함을 확인.

### 3.2 매칭 퍼널 통합
- **라우팅**
  - `/rank/[id]/start`에서 모드 선택 후 `/rank/[id]/solo|duo|casual`로 이동하는 흐름을 고정한다.
  - 사설 매치는 `/rank/[id]/casual-private`에서 방 편성 후 `/rank/[id]/start?mode=casual_private`로 이어지도록 유지한다.
- **자동 큐 진입**
  - `AutoMatchProgress`를 모든 매칭 페이지에서 호출하되, 큐 진입 전에 `heroToken`, `viewerSession`을 반드시 확보하도록 `useEffect` 의존성을 재검토한다.
  - 듀오 큐는 파티 리더가 방을 만들면 즉시 `enqueue` 호출 후 대기열 상태가 공유되도록 `DuoMatchClient`에서 파티원 동기화 신호(예: Supabase realtime)를 구독한다.
- **탈출 조건**
  - 매칭 실패, 히어로 미선택, API 오류 시 메인룸으로 자동 복귀하는 경로를 명시하고, 재시도 횟수/쿨다운 정책을 정의한다.
- **완료 조건**: 솔로/듀오/캐주얼 진입 시 버튼 추가 입력 없이 큐에 합류하고, 매칭 확정 또는 오류 복귀가 자동으로 수행됨.

### 3.3 프롬프트 엔진 확장
- **데이터 수집**
  - 게임 등록 탭에서 정의한 프롬프트 세트(`prompt_slots`, `prompt_bridges`, 변수 메타데이터)를 `loadGameBundle`이 모두 포함하도록 API 응답을 확장한다.
  - 프롬프트 제작기에서 노드/엣지 편집 시 필요한 변수 설명과 라인 순서를 미리 계산해 저장한다.
- **변수 매핑 레이어**
  - `lib/promptEngine/template.js`에 `resolveVariables({ slotMap, roleFallbacks, eliminatedPolicy })` 유틸을 도입한다.
  - 12 슬롯 매핑, 탈락 시 역할군 대체, 재참전 인식(`{heroName}_재참전`), 승패/변수 줄 위치를 공통 함수에서 책임진다.
- **AI 호출 어댑터**
  - `/api/rank/play`와 `StartClient`가 동일한 템플릿 변환기를 호출하도록 통합한다.
  - 실시간 옵션이 꺼진 경우: 설명문/캐릭터 정보 → AI 내응답 → 본 턴 AI 프롬프트 순서의 파이프라인을 함수형으로 분리한다.
- **완료 조건**: 프롬프트 제작기에서 정의한 변수들이 전투 중 그대로 반영되고, 승패/변수 줄 규칙이 일관되게 유지된다.

### 3.4 전투 세션 & 히스토리
- **세션 관리**
  - 매칭 확정 시 `rank_sessions`를 생성하고, 각 턴을 `rank_turns`에 기록하는 서버 함수를 마련한다.
  - `useBattleSession`(신규 훅)으로 세션 상태, 턴 로그, AI/사용자 입력 제한, 인비저블 필터링을 클라이언트에 제공한다.
- **난입/재참전 처리**
  - `rank_participants.status`(`active`, `victory`, `defeat`, `retired`, `intruding`) 상태 전이를 명시하고, 난입 허용 시 슬롯 재배정을 자동화한다.
  - 신규 난입자에게 히스토리/설명문을 전달하며 60초 파악 시간을 부여하는 로직을 세션 훅에서 노출한다.
- **결과 집계**
  - 세션 종료 시 `recordBattle`을 확장해 `game_id`, 승패, 점수 변화를 `rank_battles`, `rank_battle_logs`, `rank_participants`에 일괄 반영한다.
- **완료 조건**: 전투 히스토리가 Supabase에 남고, UI에서 승리/패배/탈락/난입 상태가 반영되며, AI 히스토리/사용자 히스토리가 역할·가시성 조건을 따른다.

### 3.5 오디오/비주얼 디스패치
- **오디오 매니저**
  - 주역 캐릭터를 기준으로 BGM/EQ/리버브/컴프레서 프리셋을 적용하고, 트랙 겹침을 방지하기 위해 새 트랙 재생 시 기존 트랙을 정지한다.
  - 백그라운드 전환 이벤트를 `GameRoomView`와 `StartClient` 모두에서 수신하도록 글로벌 이벤트 버스를 마련한다.
- **UI 상태**
  - 사이드 패널에 역할군별 상태 색상/아이콘/애니메이션을 정의한다.
  - 메인 UI는 반투명 오버레이와 히스토리 트레이 구조를 설계해 텍스트와 시각 요소가 충돌하지 않도록 한다.
- **완료 조건**: 턴 전환 시 오디오와 UI가 동시에 갱신되며, 승패·난입 변화를 즉시 반영한다.

### 3.6 QA & 운영 체크리스트
- **테스트 시나리오**
  - 단일 사용자 솔로/듀오/캐주얼 진입, 난입 발생, 승리/패배/탈락 전이, 실시간 옵션 On/Off, 프롬프트 변수 누락 등 주요 경로를 자동/수동 테스트한다.
  - 오디오 장치, 모바일 세로 레이아웃, 접근성(스크린 리더) 등을 포함한 QA 체크리스트를 만든다.
- **모니터링**
  - Supabase 로그와 클라이언트 에러 로깅(Sentry 등) 연동을 확인하고, 큐 실패/세션 에러에 대한 경고 지표를 정의한다.
- **롤백 전략**
  - 매칭/전투 기능이 실패할 경우 기존 수동 실행 흐름으로 되돌릴 수 있는 플래그나 환경 변수를 마련한다.

## 4. 의존성 및 병렬 작업 가이드
- **필수 선행 작업**: 슬롯 점유 로직, 세션/턴 테이블 연동은 다른 기능의 기반이 되므로 우선 처리한다.
- **병렬 가능 작업**: 오디오·UI 디테일, 프롬프트 제작기 UX 개선은 세션 로직과 병행 가능.
- **협업 포인트**: 백엔드(Supabase Edge Functions)와 프론트엔드(React) 간 API 계약을 `docs/api-contracts.md` 같은 문서로 추가 정리할 것을 권장.

## 5. 개방된 이슈
- 듀오 큐가 여러 파티를 분리해 처리할 때 점수 매칭 알고리즘의 범위 조정 필요.
- 실시간 모드 Off 시 AI 자동 응답 생성 스케줄링(지연, 실패 재시도)에 대한 백오프 전략 미정.
- 난입 허용 시 UI 노출 규칙(히스토리, 알림 배너) 상세 동작 정의가 필요.

---
느낀 점: 기존 청사진과 로드맵이 조각나 있던 부분을 하나의 단계별 계획으로 묶으니 실제 구현 순서를 훨씬 명확히 잡을 수 있었습니다.
추가로 필요한 점: 매 단계마다 확인해야 할 데이터 계약(API 응답 스키마)을 별도 문서로 정리하면 개발 간 충돌을 줄일 수 있을 것 같습니다.
진행사항: 랭크 게임 청사진을 실행 가능한 구현 계획으로 재구성해 사전 준비부터 QA까지 단계별 작업 방향을 문서화했습니다.
