# 랭크 메인 게임 실행 구조 개요

## 1. 전체 실행 흐름 요약
1. **시작 프롬프트 합성**: 블루프린트 노드 정의와 전역 변수 선언을 읽어 규칙/변수 블록이 포함된 시작 프롬프트를 자연어로 직조한다. 이 단계에서 엔진은 슬롯별 맥락과 전역 상태(난입 여부, 턴 정보 등)를 문자열로 정리한다.
2. **대화형 AI 호출**: 완성된 프롬프트를 대화형 AI API에 전달한다. 실시간 슬롯은 플레이어 키, 비실시간/대역 슬롯은 운영 키를 사용한다.
3. **응답 수신 및 파싱**: API 응답을 받으면 본문과 하단 메타 섹션(주역/변수/결과)을 분리해 변수 값, 승패·탈락 여부, 무승부 상태를 파악한다.
4. **브리지 평가 및 이동**: 파싱 결과를 현재 노드의 브리지 조건과 대조해 충족하는 브리지를 선택하고, 브리지 목적지 노드의 프롬프트 정의를 불러온다.
5. **다음 프롬프트 합성**: 목적지 노드의 규칙, 로컬 변수, 전역 변수 상태를 반영해 새 프롬프트를 다시 자연어로 직조한다. 이후 2단계부터 반복한다.
6. **종료 검사**: 모든 역할군의 승패가 결정되었거나 종료 변수/Stop 신호가 감지되면 반복을 중단하고 세션을 마무리한다.

## 2. 프롬프트 구성 규칙
- **규칙 블록**: 프롬프트 상단에 기본 규칙과 체크박스/옵션에서 유도된 추가 규칙을 나열한다. 우선순위가 높은 항목이 유사 문구를 대체하고, 불필요한 중복은 제거한다.
- **변수 선언**:
  - **전역 변수**: 전역 상태에 영향을 주는 변수는 규칙 블록 하단에 항상 표시된다. 예: `게임종료`, `난입가능` 등.
  - **로컬 변수**: 특정 노드에서만 사용하는 변수는 해당 노드의 규칙 아래, 구분선 위에 표시된다.
- **본문 구분선**: 규칙/변수 블록과 실제 프롬프트 본문 사이에 `-------------------------------------------` 구분선을 사용한다.
- **본문 내용**: 현재 턴의 상황, 슬롯별 역할, 참고 히스토리 요약을 포함해 AI가 상황을 이해하고 응답을 생성할 수 있도록 한다.

## 3. 응답 형식 표준
1. **본문 서술**: 상단에는 자유 형식의 서술을 허용한다. 규칙에 따라 승패를 억지로 비트는 표현은 제한된다.
2. **공백 구분**: 본문 아래에는 연속된 공백 줄 다섯 개를 둔다. 이 영역은 후속 기록을 위한 버퍼로 비워 둔다.
3. **메타 섹션** (아래에서 위로 읽기):
   - **마지막 줄**: 이번 턴의 핵심 캐릭터 이름과 결과(승, 패, 탈락, 무 등)를 기재한다. 결과가 확정되지 않았다면 `무`를 기재한다.
   - **마지막에서 두 번째 줄**: 활성화된 변수 이름을 공백으로 구분해 나열한다. 없으면 `none`을 기재한다.
   - **마지막에서 세 번째 줄**: 비중이 높은 캐릭터 이름을 기재한다. 특별히 중요하지 않으면 공란을 유지한다.

## 4. 변수 및 결과 파이프라인
- **변수 파서**: 응답 메타 섹션을 파싱해 전역/로컬 변수 상태를 업데이트한다. 다중 변수는 공백 분리 문자열로 처리한다.
- **승패 판별**: 마지막 줄의 결과 토큰을 기준으로 승리, 패배, 탈락, 무승부를 결정한다. 결과가 결정된 슬롯은 세션 상태에 즉시 반영된다.
- **게임 종료 플래그**: 전역 변수 중 종료 플래그가 활성화되거나 모든 역할군의 승패가 확정되면 엔진은 종료 절차를 예약한다.

## 5. 브리지 처리 로직
1. **조건 검사**: 현재 노드에서 선언된 브리지들을 순서대로 확인하고, 변수/승패 상태/턴 카운터/슬롯 생존 여부를 평가한다.
2. **우선순위 선택**: 조건을 만족하는 첫 브리지가 선택되며, 브리지 목적지 노드 ID를 반환한다.
3. **미충족 시 폴백**: 어떤 브리지 조건도 충족하지 못하면 기본 폴백(무승부 노드 또는 종료 노드)으로 이동한다.
4. **Stop 신호 처리**: 응답에서 `stop` 의도가 감지되면 브리지 평가 전에 즉시 종료 루틴을 호출한다.

## 6. 반복 종료 조건
- **승패 완결**: 남은 역할군이 없거나 모든 역할군의 승패가 확정되면 세션이 종료된다.
- **종료 변수**: 전역 변수 목록에 종료 플래그가 등장하면 즉시 종료한다.
- **브리지 단절**: 평가 가능한 브리지가 더 이상 없고 승패도 결정되지 않았다면 `무` 처리를 기록한 뒤 종료한다.
- **운영 중단**: 관리자가 세션 중지(Stop)를 요청하거나 API 호출에 심각한 오류가 발생하면 안전 종료 절차를 수행한다.

## 7. 관련 모듈 맥락
- `promptInterpreter`: 규칙/변수 블록을 합성하고 응답 메타를 파싱해 상태 업데이트를 담당한다.
- `startClientEngine`: 세션 상태를 관리하고 브리지 평가, 반복 진행, 종료 검사를 총괄한다.
- `historyBuffer` 및 타임라인 모듈: 각 턴의 프롬프트, 응답, 변수 변화를 기록해 후속 로그와 배틀 리플레이에 제공한다.

이 구조를 통해 메인 게임은 변수와 프롬프트를 반복적으로 해석하고, AI 응답에 따라 조건을 충족하는 브리지로 이동하면서 자연스러운 스토리 진행과 승패 판정을 달성한다.
