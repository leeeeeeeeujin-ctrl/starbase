# Rank ê²Œì„ ë°±ì—”ë“œ êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

í”„ë¡ íŠ¸ì—”ë“œ ë¦¬íŒ©í† ë§ê³¼ ì‹¤ì‹œê°„ ê³„íš í™•ì¥ì— ë§ì¶°, SupabaseÂ·Edge FunctionsÂ·ì„œë²„ ìœ í‹¸ì´ ë³´ê°•í•´ì•¼ í•  í•­ëª©ì„ ëª¨ì•„ë‘” ë¬¸ì„œë‹¤. ìš°ì„ ìˆœìœ„ëŠ” "ì¦‰ì‹œ ëŒ€ì‘" â†’ "ë§¤ì¹­/ë°©" â†’ "ë³¸ê²Œì„" ìˆœìœ¼ë¡œ ì§„í–‰í•˜ë©°, ê° í•­ëª©ì€ ì§„í–‰ ìƒí™©ì— ë”°ë¼ âœ…(ì™„ë£Œ) / ğŸ”„(ì§„í–‰ ì¤‘) / â˜(ë¯¸ì°©ìˆ˜)ë¡œ ì—…ë°ì´íŠ¸í•œë‹¤.

> ğŸ“¦ ì´ë²ˆ íšŒì°¨ì—ì„œëŠ” `docs/supabase-rank-backend-upgrades.sql`ì— ê³µí†µ ìŠ¤í‚¤ë§ˆÂ·RPCÂ·ì •ì±… ì´ˆì•ˆì„ ì¶”ê°€í–ˆë‹¤. ì•„ë˜ ì²´í¬ë¦¬ìŠ¤íŠ¸ì˜ ğŸ”„ í•­ëª©ì€ SQLì´ ì¤€ë¹„ë˜ì—ˆìœ¼ë©°, Supabaseì— ì ìš©í•˜ë©´ ì¦‰ì‹œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

## 1. ì¦‰ì‹œ ëŒ€ì‘ì´ í•„ìš”í•œ ê³µí†µ ì‘ì—…
- âœ… `verify_rank_roles_and_slots` RPCë¥¼ ì¶”ê°€í•´ ë“±ë¡Â·ë§¤ì¹­Â·ë£¸ ìŠ¤í…Œì´ì§•ì—ì„œ ë™ì¼í•œ ì—­í• /ìŠ¬ë¡¯ ê²€ì¦ ë¡œì§ì„ ì‚¬ìš©í•˜ë„ë¡ í†µí•©í–ˆë‹¤. í•¨ìˆ˜ ì •ì˜ëŠ” `docs/sql/verify-rank-roles-and-slots.sql`ê³¼ ë²ˆë“¤ íŒŒì¼ì— í¬í•¨ë˜ì–´ ìˆìœ¼ë©°, `/api/rank/register-game`ì´ ë°°í¬ ì—¬ë¶€ì— ë”°ë¼ ìë™ìœ¼ë¡œ í˜¸ì¶œí•œë‹¤.ã€F:docs/sql/verify-rank-roles-and-slots.sqlâ€ L1-L111ã€‘ã€F:docs/supabase-rank-backend-upgrades.sqlâ€ L968-L1059ã€‘ã€F:pages/api/rank/register-game.jsâ€ L36-L83ã€‘
- âœ… `RoomInitService`ê°€ ì°¸ì¡°í•  `rank_room_slot_cache` í…Œì´ë¸”ê³¼ í–‰ ë‹¨ìœ„ ì ê¸ˆì„ ì œê³µí•˜ëŠ” RPCë¥¼ ì‘ì„±í•´, ì‹¤ì‹œê°„ ì…ì¥ ê²½ìŸ ì‹œ ìŠ¬ë¡¯ ê²½í•©ì„ ë°©ì§€í•œë‹¤. ìŠ¬ë¡¯ ìºì‹œ í…Œì´ë¸”ê³¼ `claim_rank_room_slot` RPC SQLì„ `supabase-rank-session-sync-guide.md`ì— ìŠ¤ë‹ˆí«ìœ¼ë¡œ ì •ë¦¬í–ˆë‹¤.ã€F:docs/supabase-rank-session-sync-guide.mdâ€ L55-L111ã€‘
- âœ… `validate_session` RPCì— ìŠ¬ë¡¯ ë²„ì „(`slot_schema_version`)ê³¼ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ í¬í•¨í•´ GameSession Storeê°€ í´ë¼ì´ì–¸íŠ¸-ì„œë²„ ê°„ ë²„ì „ ì°¨ì´ë¥¼ ê°ì§€í•  ìˆ˜ ìˆê²Œ í•œë‹¤. `rank_sessions` ì»¬ëŸ¼ í™•ì¥ê³¼ `validate_session`/`bump_rank_session_slot_version` RPC êµì²´ SQLì„ ê°™ì€ ê°€ì´ë“œì— ë‹´ì•˜ë‹¤.ã€F:docs/supabase-rank-session-sync-guide.mdâ€ L16-L73ã€‘
- ğŸ”„ ì´ë¯¸ì§€ ì—…ë¡œë“œ Edge Functionì— 3MB ìš©ëŸ‰ ì œí•œê³¼ MIME í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ë¥¼ ì ìš©í•´, í”„ë¡ íŠ¸ì˜ ì‚¬ì „ ê²€ì¦(`RankNewClient` ì´ë¯¸ì§€ ê²€ì‚¬)ê³¼ ë°±ì—”ë“œ ì •ì±…ì„ ì¼ì¹˜ì‹œí‚¨ë‹¤. `rank-game-covers` ë²„í‚· ì „ìš© íŠ¸ë¦¬ê±°ì™€ ì •ì±…ì„ SQLì— ì¶”ê°€í–ˆë‹¤.
- ğŸ”„ `rank_game_logs`(ê°€ì¹­) ê°ì‚¬ í…Œì´ë¸”ì„ í™•ì¥í•´ ë“±ë¡/ë§¤ì¹­/ë³¸ê²Œì„ì—ì„œ ë°œìƒí•˜ëŠ” ì£¼ìš” ì´ë²¤íŠ¸ì™€ ì‹¤íŒ¨ ì¼€ì´ìŠ¤ë¥¼ ëª¨ë‘ ê¸°ë¡í•œë‹¤. ê°ì‚¬ í…Œì´ë¸”ê³¼ ì¸ë±ìŠ¤, ì„œë¹„ìŠ¤ ë¡¤ ì •ì±…ì„ SQLë¡œ ë§ˆë ¨í–ˆë‹¤.

## 2. ê²Œì„ ë“±ë¡ ì§€ì›
- ğŸ”„ `register-game` APIì—ì„œ ì—­í•  ì ìˆ˜ ë²”ìœ„Â·ë‚œì… ì¢…ë£Œ ì¡°ê±´ ê²€ì¦ì„ RPCì— ìœ„ì„í•˜ê³ , ì‹¤íŒ¨ ì‚¬ìœ ë¥¼ í”„ë¡ íŠ¸ì— ì „ë‹¬í•  ìˆ˜ ìˆë„ë¡ ì˜¤ë¥˜ ì½”ë“œë¥¼ í†µì¼í•œë‹¤. í˜„ì¬ëŠ” í”„ë¡ íŠ¸Â·APIê°€ `prepareRegistrationPayload` ìœ í‹¸ì„ ê³µìœ í•˜ë„ë¡ ë§ì¶° 1ì°¨ ë™ê¸°í™”ë¥¼ ëëƒˆìœ¼ë©°, ë‹¤ìŒ ë‹¨ê³„ë¡œ RPCë¡œ ë¶„ë¦¬í•˜ê³  ì—ëŸ¬ ì½”ë“œë¥¼ ì •ì˜í•´ì•¼ í•œë‹¤.ã€F:lib/rank/registrationValidation.jsâ€ L1-L87ã€‘ã€F:pages/api/rank/register-game.jsâ€ L1-L120ã€‘
- ğŸ”„ í”„ëŸ°íŠ¸ê°€ Supabase í…Œì´ë¸”ì„ ì§ì ‘ í˜¸ì¶œí•˜ì§€ ì•Šë„ë¡ `/api/rank/register-game`ì´ ì—­í• Â·ìŠ¬ë¡¯ì„ ëª¨ë‘ ì €ì¥í•˜ê²Œ ì „í™˜í–ˆìœ¼ë©°, `register_rank_game` RPC SQL(`docs/sql/register-rank-game.sql`)ì„ ë°°í¬í•˜ë©´ ì„œë²„ì—ì„œë„ ë™ì¼í•œ ì €ì¥ ê²½ë¡œë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ìµœì‹  ìŠ¤ë‹ˆí«ì€ `roles` ì»¬ëŸ¼ì„ `jsonb_agg`ë¡œ ë‚´ë³´ë‚´ê³ , ëˆ„ë½ë¼ ìˆë˜ `rank_game_slots_game_id_slot_index_key` ìœ ë‹ˆí¬ ì œì•½ì„ ìë™ ìƒì„±í•˜ë¯€ë¡œ íƒ€ì… ë¶ˆì¼ì¹˜Â·ì œì•½ ë¶€ì¬ ì—ëŸ¬ ì—†ì´ ê·¸ëŒ€ë¡œ ì‹¤í–‰í•´ë„ ëœë‹¤.ã€F:components/rank/RankNewClient.jsâ€ L24-L340ã€‘ã€F:pages/api/rank/register-game.jsâ€ L1-L120ã€‘ã€F:docs/sql/register-rank-game.sqlâ€ L1-L115ã€‘
- â˜ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¬ì‹œë„ ë¡œì§ê³¼ ì—…ë¡œë“œ ì‹¤íŒ¨ ì›ì¸(ìš©ëŸ‰ ì´ˆê³¼, í™•ì¥ì ë¶ˆì¼ì¹˜ ë“±)ì„ Supabase `storage` ì—ëŸ¬ ë©”ì‹œì§€ë¡œ êµ¬ë¶„í•´ ë¡œê¹…í•œë‹¤.
- âœ… í”„ë¡¬í”„íŠ¸ ì„¸íŠ¸ IDê°€ ì‚­ì œëœ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ `prompt_set_id` ì¡´ì¬ ì—¬ë¶€ë¥¼ ë“±ë¡ APIì—ì„œ í™•ì¸í•˜ê³ , ëˆ„ë½ ì‹œ `invalid_prompt_set` ì˜¤ë¥˜ë¥¼ ë°˜í™˜í•˜ë„ë¡ ë³´ê°•í–ˆë‹¤.ã€F:pages/api/rank/register-game.jsâ€ L38-L64ã€‘

## 3. ë§¤ì¹­Â·ë°© ë‹¨ê³„
- â˜ ë¡œë¹„ ìë™ ìƒˆë¡œê³ ì¹¨ì— ì‚¬ìš©ë˜ëŠ” `fetchRoomSummaries` RPCë¥¼ ë³´ê°•í•´, ìƒˆ GameSession Store ë²„ì „ í•„ë“œë¥¼ ë°˜í™˜í•˜ê³  ì‹¤ì‹œê°„ ì±„ë„ì—ì„œ ë™ì¼ êµ¬ì¡°ë¥¼ ê³µìœ í•œë‹¤.
- âœ… ë°© ìƒì„¸ í˜ì´ì§€ê°€ í˜¸ì¶œí•˜ëŠ” `stage-room-match` RPCì— ë‚™ê´€ì  ë½ê³¼ ìŠ¬ë¡¯ ë²„ì „ ê²€ì¦ì„ ë„ì…í–ˆë‹¤. `docs/sql/sync-rank-match-roster.sql`(ë˜ëŠ” ë²ˆë“¤ íŒŒì¼)ì˜ `sync_rank_match_roster` í•¨ìˆ˜ê°€ ìŠ¬ë¡¯ ë²„ì „ì„ ë¹„êµí•˜ê³  ì¶©ëŒ ì‹œ `slot_version_conflict` ì˜¤ë¥˜ë¥¼ ë°˜í™˜í•œë‹¤.
- ğŸ”„ ë¹„ì‹¤ì‹œê°„ ëª¨ë“œì—ì„œ ë¶€ì¡± ì¸ì›ì„ ìë™ ì¶©ì›í•  ë•Œ ì‚¬ìš©í•  `async_fill_queue` í…Œì´ë¸”ê³¼ ê´€ë ¨ RPCë¥¼ ì„¤ê³„í•´, ì—­í• êµ°ë³„ ì¢Œì„ ì œí•œê³¼ ì¤‘ë³µ ë°©ì§€ë¥¼ ì„œë²„ì—ì„œ ê°•ì œí•œë‹¤. `refresh_match_session_async_fill` RPCê°€ `rank_room_slots`Â·`rank_match_queue` ë°ì´í„°ë¥¼ ì´ìš©í•´ ì¢Œì„ ì œí•œê³¼ ëŒ€ê¸°ì—´ì„ ê³„ì‚°í•˜ë„ë¡ SQL ìŠ¤ë‹ˆí«ìœ¼ë¡œ ì¤€ë¹„ë˜ì–´ ìˆìœ¼ë©°(`docs/sql/refresh-match-session-async-fill.sql`), í…Œì´ë¸” ì˜ì†í™” ë° Edge Function ì—°ë™ì€ í›„ì† ì‘ì—…ìœ¼ë¡œ ë‚¨ì•„ ìˆë‹¤.ã€F:docs/sql/refresh-match-session-async-fill.sqlâ€ L1-L220ã€‘

## 4. ë³¸ê²Œì„Â·ì„¸ì…˜ ë©”íƒ€
- âœ… `upsert_match_session_meta`(ê°€ì¹­) RPCë¥¼ ë§Œë“¤ì–´ ì œí•œì‹œê°„ íˆ¬í‘œ ê²°ê³¼, ë‚œì… ë³´ë„ˆìŠ¤ ë¡œê·¸, í„´ ìƒíƒœ(`turn_state`), ë¹„ì‹¤ì‹œê°„ ìë™ ì¶©ì› íˆìŠ¤í† ë¦¬ë¥¼ í•œ ê³³ì— ì €ì¥í•œë‹¤. `refresh_match_session_async_fill` RPCëŠ” ì¢Œì„ ì œí•œÂ·ëŒ€ê¸°ì—´ ìŠ¤ëƒ…ìƒ·ì„ ê³„ì‚°í•´ ê°™ì€ í…Œì´ë¸”ì— ì €ì¥í•˜ë„ë¡ í™•ì¥ëìœ¼ë©°, ë‘ í•¨ìˆ˜ ëª¨ë‘ SQL ìŠ¤ë‹ˆí«ìœ¼ë¡œ ì œê³µëœë‹¤. ë¹ ë¥´ê²Œ ë°°í¬í•˜ë ¤ë©´ `docs/sql/upsert-match-session-meta.sql`ê³¼ `docs/sql/refresh-match-session-async-fill.sql` íŒŒì¼ì„ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ìœ¼ë©´ ëœë‹¤.ã€F:docs/supabase-rank-session-sync-guide.mdâ€ L88-L216ã€‘ã€F:docs/sql/upsert-match-session-meta.sqlâ€ L1-L120ã€‘ã€F:docs/sql/refresh-match-session-async-fill.sqlâ€ L1-L220ã€‘
- âœ… `/api/rank/session-meta`ê°€ `upsert_match_session_meta`ì™€ `enqueue_rank_turn_state_event` RPCë¥¼ í˜¸ì¶œí•˜ë„ë¡ êµ¬ì„±ë˜ì–´, StartClientê°€ ì„¸ì…˜ ë©”íƒ€ì™€ í„´ ìƒíƒœë¥¼ ì„œë²„ì™€ ë™ê¸°í™”í•œë‹¤. í”„ëŸ°íŠ¸ëŠ” `buildSessionMetaRequest` ìœ í‹¸ì„ í†µí•´ ì œí•œì‹œê°„Â·ëŒ€ê¸°ì—´ ì •ë³´ë¥¼ ì •ê·œí™”í•˜ê³  ì´ APIë¥¼ í˜¸ì¶œí•´ ì¦‰ì‹œ ë°˜ì˜í•œë‹¤.ã€F:pages/api/rank/session-meta.jsâ€ L1-L170ã€‘ã€F:components/rank/StartClient/index.jsâ€ L1-L260ã€‘ã€F:lib/rank/sessionMetaClient.jsâ€ L1-L240ã€‘
- ğŸ”„ í„´ ìƒíƒœë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¸Œë¡œë“œìºìŠ¤íŠ¸í•˜ê¸° ìœ„í•œ `rank_turn_state_events` í…Œì´ë¸”ê³¼ `enqueue_rank_turn_state_event` RPCë¥¼ ë°°í¬í•œë‹¤. Supabase Realtimeì´ í…Œì´ë¸” ë³€ê²½ì„ ë°©ì†¡í•˜ë„ë¡ `docs/sql/rank-turn-realtime-sync.sql`ì„ ì‹¤í–‰í•˜ë©´ ë˜ê³ , ì„¸ì…˜ ë©”íƒ€ upsertì™€ ë™ì¼í•œ íŠ¸ëœì­ì…˜ì—ì„œ í„´ ìŠ¤ëƒ…ìƒ·ì„ ê¸°ë¡í•œë‹¤.ã€F:docs/sql/rank-turn-realtime-sync.sqlâ€ L1-L101ã€‘ã€F:docs/supabase-rank-session-sync-guide.mdâ€ L220-L231ã€‘
- ğŸ”„ ì‹¤ì‹œê°„ ëˆ„ë½ë¶„ì„ ë°±í•„í•˜ëŠ” `fetch_rank_turn_state_events` RPCë¥¼ ì¶”ê°€ ë°°í¬í•´ ì±„ë„ ë³µêµ¬ ì‹œ ìµœëŒ€ 200ê°œì˜ ì´ë²¤íŠ¸ë¥¼ ì‹œê°„ ìˆœìœ¼ë¡œ ë˜ëŒë¦´ ìˆ˜ ìˆë‹¤. SQL ìŠ¤ë‹ˆí«ì€ `docs/sql/fetch-rank-turn-state-events.sql`ì— ì •ë¦¬ë˜ì–´ ìˆìœ¼ë©°, `/api/rank/turn-events`ê°€ í•´ë‹¹ RPCë¥¼ í˜¸ì¶œí•˜ë„ë¡ ì¤€ë¹„ëë‹¤.ã€F:docs/sql/fetch-rank-turn-state-events.sqlâ€ L1-L63ã€‘ã€F:docs/supabase-rank-session-sync-guide.mdâ€ L233-L249ã€‘
- â˜ `start_match` Edge Functionì—ì„œ ìœ„ ë©”íƒ€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ `turnTimerService`ì™€ `dropInQueueService`ê°€ ë™ì¼í•œ íƒ€ì´ë¨¸/ë³´ë„ˆìŠ¤ ê°’ì„ ë°›ë„ë¡ ì´ˆê¸°í™”í•œë‹¤.
- â˜ ìƒˆë¡œ ë‚œì…í•œ ì°¸ê°€ìì—ê²Œ 30ì´ˆ ë³´ë„ˆìŠ¤ë¥¼ ë¶€ì—¬í•˜ëŠ” ê·œì¹™ì„ ì„œë²„ íƒ€ì„ë¼ì¸ì—ë„ ê¸°ë¡í•´, í´ë¼ì´ì–¸íŠ¸-ì„œë²„ íƒ€ì´ë¨¸ ì‹±í¬ë¥¼ ê²€ì¦í•  ìˆ˜ ìˆê²Œ í•œë‹¤.

## 5. ê´€ì¸¡ì„± ë° í›„ì† ì‘ì—…
- â˜ Supabaseì—ì„œ í…ŒìŠ¤íŠ¸ ì „ìš© í”„ë¡œì íŠ¸/í…Œì´ë¸”ì„ ë¶„ë¦¬í•´ CI ë° ìŠ¤í…Œì´ì§•ì—ì„œ ì•ˆì „í•˜ê²Œ RPCì™€ í•¨ìˆ˜ ê²€ì¦ì„ ìˆ˜í–‰í•œë‹¤.
- â˜ ë¹„ì‹¤ì‹œê°„ ìë™ ì¶©ì› í†µê³„ ëŒ€ì‹œë³´ë“œë¥¼ Supabase SQL View í˜¹ì€ Edge Functionìœ¼ë¡œ ì„¤ê³„í•´ ìš´ì˜íŒ€ì´ í™œìš©í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤.
- â˜ ë‹¤êµ­ì–´ ì „í™˜ì„ ëŒ€ë¹„í•´ Rank ë“±ë¡/ë§¤ì¹­ê³¼ ê´€ë ¨ëœ ì‹œìŠ¤í…œ ë©”ì‹œì§€ë¥¼ `rank_localized_messages` í…Œì´ë¸”ë¡œ ì¶”ì¶œí•˜ê³ , í”„ë¡ íŠ¸ëŠ” í‚¤ ê¸°ë°˜ ì¡°íšŒë¥¼ ì‚¬ìš©í•˜ë„ë¡ ë°”ê¾¼ë‹¤.

## 6. ì§„í–‰ ë©”ëª¨
- í”„ë¡ íŠ¸ì—ì„œëŠ” ë“±ë¡ í¼ì— 3MB ì´ë¯¸ì§€ ì œí•œÂ·ë¯¸ë¦¬ë³´ê¸°, ë‚œì… ì¢…ë£Œ ì¡°ê±´ í•„ìˆ˜ ê²€ì¦ì´ ë°˜ì˜ë˜ì–´ ìˆìœ¼ë¯€ë¡œ, ë°±ì—”ë“œ ê²€ì¦ ì‹¤íŒ¨ ì‹œ ë™ì¼í•œ ë©”ì‹œì§€ë¥¼ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì˜¤ë¥˜ ì½”ë“œ ë§¤í•‘ì´ í•„ìš”í•˜ë‹¤.
- GameSession Store í™•ì¥ ì‘ì—…(ìŠ¬ë¡¯ ë²„ì „, ì„¸ì…˜ ë©”íƒ€ íˆ¬í‘œ)ì€ í”„ë¡ íŠ¸ ê³„íš ë¬¸ì„œ(`game-implementation-plan.md`) 5ë‹¨ê³„ì™€ ì—°ë™ë˜ì–´ ìˆì–´, ë°±ì—”ë“œê°€ ì„ í–‰ ì¤€ë¹„ë¥¼ ë§ˆì¹˜ë©´ í”„ë¡ íŠ¸ ë¦´ë¦¬ì¦ˆë¥¼ ë‹¨ê³„ì ìœ¼ë¡œ ì „í™˜í•  ìˆ˜ ìˆë‹¤.
